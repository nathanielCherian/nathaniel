<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Game</title>
</head>
<body>
    
    <button onclick="getRelatedArtists('Kings of leon')">CLICK</button>
    <div id="container">
        <div id="step-1" style="display: none;">
            <div id="start-artist"></div>
            <div id="end-artist"></div>

            <div id="difficulty-box">
                <input type="radio" id="easy-button" name="difficulty" value="EASY" checked>
                <label for="easy-button">easy</label><br>
                <input type="radio" id="css" name="difficulty" value="HARD">
                <label for="hard-button">hard</label><br>
            </div>

            <button id="start-button" onclick="start()" disabled>Start</button>
        </div>
        
        <div id="step-2" style="display: block">
            <p>Start at: <b><span id="start-artist-span" class="artist-name-text"></span></b></p>
            <p>End at: <b><span id="end-artist-span" class="artist-name-text"></span></b></p>
            <p>Difficulty: <span id="difficulty-span" class="artist-name-text"></span></p>
            <p id="artist-chain"></p>
            <div id="artist-options"></div>
        </div>

    </div>
    
    <script>

        const queryURL = (query) => `https://www.music-map.com/typeahead?query=${query}`;
        const difficultyTranslator = {
            0: "easy",
            1: "hard"
        }

        const difficultyScale = {
            0: .5,
            1: .15
        }


        function displayError(msg) {
            console.error(msg);
        }


        async function getRelatedArtists(artistName) {
            const res = await fetch(`/sketches/api/musicmap/${artistName}`);
            const data = await res.text();
            const parser = new DOMParser();
            const parsedDocument = parser.parseFromString(data, "text/html");
            const gnodMap = parsedDocument.getElementById("gnodMap")
            const artists = Array.from(gnodMap.querySelectorAll("a")).slice(1).map((artistElement) => artistElement.text);
            console.log(artists);
            return artists;
        }

        async function chooseArtist(artist) {
            artistChain.push(artist);
            document.getElementById("artist-chain").innerHTML = window.artistChain.reduce((prev, cur, i) => {
                return prev + cur + " -> "
            }, "");
            if (artist == window.endArtist) {
                const artistChain = document.getElementById("artist-chain");
                const chain = artistChain.innerHTML;
                artistChain.innerHTML = chain.substring(0, chain.length - 7)
                const artistOptions = document.getElementById("artist-options"); artistOptions.innerHTML = "";
                return;
            }

            const artists = await getRelatedArtists(artist)
            const chosenArtists = Math.round((artists.length)*difficultyScale[window.difficulty]);
            const randomArtists = artists.sort( () => Math.random() - 0.5).slice(0, chosenArtists);
            if (artists.includes(window.endArtist) && !randomArtists.includes(window.endArtist)) {
                randomArtists[Math.floor(Math.random()*randomArtists.length)] = window.endArtist;
            }
            const artistOptions = document.getElementById("artist-options"); artistOptions.innerHTML = "";
            randomArtists.forEach((artist) => {
                const item = document.createElement("p");
                item.innerHTML = artist;
                item.className = "item"
                if (artist == window.endArtist) item.className += " special-item"
                item.onclick = () => {
                    artistOptions.innerHTML = "";
                    chooseArtist(artist);
                }
                artistOptions.append(item);
            });
            console.log(randomArtists);
        }

        async function startStep2() {
            document.getElementById('step-2').style.display = "block";
            document.getElementById("start-artist-span").innerHTML = window.startArtist;
            document.getElementById("end-artist-span").innerHTML = window.endArtist;
            document.getElementById("difficulty-span").innerHTML = difficultyTranslator[window.difficulty];
            window.artistChain = []

            chooseArtist(window.startArtist);

        }


        window.startArtist = "Meek Mill";
        window.endArtist = "Kanye West";
        window.difficulty = 0;
        startStep2();

        async function validateAristName(name) {
            const res = await fetch(queryURL(name))
            const data = (await res.text()).trim();
            if (data.length == 0) return false;
            return data.split('\n')[0] == name;
        }        

        async function start() {
            const startArtist = document.getElementById("start-artist-input").value;
            const endArtist = document.getElementById("end-artist-input").value;
            if (!(await validateAristName(startArtist) && await validateAristName(endArtist))) {
                displayError("Artist names are not valid");
                return;
            }
            window.startArtist = startArtist;
            window.endArtist = endArtist;

            if (document.getElementById('easy-button').checked) {
                window.difficulty = 0;
            } else if (document.getElementById('hard-button').checked) {
                window.difficulty = 1;
            }

            document.getElementById("step-1").style.display = "none";
            startStep2();
        }
        
        function updateStartButton() {
            const startArtistName = document.getElementById("start-artist-input").value.trim();
            const endArtistName = document.getElementById("end-artist-input").value.trim();
            const startButton = document.getElementById("start-button");
            if (startArtistName.length != 0 && endArtistName.length != 0) {
                startButton.disabled = false;
            } else {
                startButton.disabled = true;
            }
        }

        function artistSelectionButton(containerID, placeholder){
            const container = document.getElementById(containerID);
            const inputField = document.createElement("input");
            const dropdown = document.createElement("div")
            inputField.type = "text";
            inputField.id = `${containerID}-input`;
            inputField.placeholder = placeholder;
            inputField.className = "artist-name"
            dropdown.className = "dropdown"

            const createDropdownElement = (text, specialClass) => {
                const item = document.createElement("p");
                item.innerHTML = text;
                if (specialClass == "") {
                    item.onclick = () => {
                        dropdown.innerHTML = "";
                        inputField.value = text;
                    }
                }
                item.className = ["dropdown-item", specialClass].join(" ");
                return item;
            }

            inputField.onkeyup = () => {
                fetch(queryURL(inputField.value))
                    .then(res => res.text())
                    .then(data => {
                        dropdown.innerHTML = "";
                        const artists = data.split("\n")
                        if (artists[0] == '') {
                            if (inputField.value.trim().length != 0) {
                                dropdown.appendChild(createDropdownElement("no artists found", "error-item"));
                            }
                        } else {
                            artists.forEach(artist => {
                                dropdown.appendChild(createDropdownElement(artist, ""))
                            }); 
                        }
                    });
                    updateStartButton();
            };

            container.appendChild(inputField);
            container.appendChild(dropdown);
        }

        artistSelectionButton("start-artist", "starting artist")
        artistSelectionButton("end-artist", "ending artist")

        const START_BUTTON = document.getElementById("start-button");
        
    </script>

    <style>
        .dropdown-item, .item {
            width: 200px;
            border: 2px solid black;
            cursor:pointer;
            padding: 3px;
            margin: 3px;
        }

        .error-item {
            cursor: default;
        }

        .special-item {
            border: 2px solid red;
        }

        #artist-options {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
        }

</style>

</body>
</html>